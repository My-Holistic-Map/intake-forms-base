<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Assessment Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #879683 0%, #404e2c 100%);
        }
        .hidden-element { display: none; }
        .form-container { background-color: #fed695; border: 2px solid #879683; }
        .header-gradient { background: linear-gradient(135deg, #3b3e2e 0%, #404e2c 100%); }
        .heading-color { color: #a15236; }
        .text-color { color: #3b3e2e; }
        .button-primary { background: linear-gradient(135deg, #a15236 0%, #483621 100%); color: #fed695; }
        .button-primary:hover { opacity: 0.9; }
        .button-secondary { background-color: #879683; color: #fed695; }
        .button-secondary:hover { background-color: #767034; }
        .question-group { border: 2px solid #879683; }
        .question-group legend { color: #a15236; }
        .result-card { background: linear-gradient(135deg, #767034 0%, #483621 100%); color: #fed695; }
        .result-card-top { border: 2px solid #a15236; }
    </style>
</head>
<body class="text-gray-800">

    <div class="max-w-4xl mx-auto p-4 sm:p-6">
        <header id="pageHeader" class="text-center mb-6 rounded-lg shadow-lg p-6 header-gradient text-white">
            <h1 id="assessmentTitle" class="text-4xl font-bold text-yellow-200">Assessment Engine</h1>
            <p id="assessmentIntro" class="text-lg text-yellow-100 mt-2 max-w-3xl mx-auto"></p>
            <nav id="primaryNav" class="mt-4 flex justify-center items-center flex-wrap gap-x-6 gap-y-2 text-yellow-200"></nav>
        </header>
        
        <div id="breadcrumbContainer" class="mb-4 text-sm text-white px-2"></div>

        <main id="mainContent" class="form-container p-6 sm:p-8 rounded-xl shadow-2xl">
            <!-- Uploader is shown only in testing mode -->
            <div id="uploaderContainer" class="text-center">
                <h2 class="text-2xl font-bold heading-color">Test an Assessment</h2>
                <p class="text-lg text-color mt-2">Upload a spreadsheet to begin.</p>
                <input type="file" id="fileUploader" class="mt-4 mx-auto block w-full max-w-xs text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            </div>
            <!-- Form content will be injected here -->
            <div id="formContainer"></div>
        </main>

        <div id="navigationContainer" class="mt-8 text-center"></div>
        <div id="resultsContainer" class="hidden-element mt-8"></div>

        <footer id="pageFooter" class="mt-12 pt-8 border-t border-gray-400 border-opacity-50 text-white"></footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // --- State Management ---
        let formRules = {};
        let userState = {};

        // --- DOM References ---
        const mainContent = document.getElementById('mainContent');
        const uploaderContainer = document.getElementById('uploaderContainer');
        const formContainer = document.getElementById('formContainer');
        const navContainer = document.getElementById('navigationContainer');
        const resultsContainer = document.getElementById('resultsContainer');
        const fileUploader = document.getElementById('fileUploader');
        
        fileUploader.addEventListener('change', handleFileUpload);
        
        /**
         * INITIALIZATION LOGIC
         * This function runs on page load and determines whether to run in 
         * "Production Mode" (loading a form from a URL) or 
         * "Testing Mode" (showing the file uploader).
         */
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const formName = params.get('form');

            if (formName) {
                // --- Production Mode ---
                // A form name was found in the URL. Hide the uploader and load the file.
                uploaderContainer.classList.add('hidden-element');
                // Assume files are in a /forms/ directory relative to this HTML file.
                const filePath = `./forms/sheets/${formName}.xlsx`; 
                loadFormFromUrl(filePath);
            } else {
                // --- Testing Mode ---
                // No form name in the URL. The uploader is visible by default.
                console.log("Testing mode: Awaiting file upload.");
            }
        });

        /**
         * Fetches and loads a spreadsheet from a given URL.
         * @param {string} url - The path to the .xlsx file.
         */
        /*
        async function loadFormFromUrl(url) {
            try {
                mainContent.innerHTML = `<p class="text-center text-lg text-color">Loading assessment...</p>`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Form not found. Server responded with status: ${response.status}`);
                }
                const data = await response.arrayBuffer();
                processSpreadsheet(data);
            } catch (error) {
                console.error("Error loading form from URL:", error);
                mainContent.innerHTML = `<p class="text-center text-red-500 text-lg">Error: The requested assessment could not be loaded. Please check the 'form' parameter in the URL.</p>`;
            }
        }
        */

        /**
         * Fetches and loads a spreadsheet from a given URL.
         * This version includes extra logging to debug silent failures.
         * @param {string} url - The path to the .xlsx file.
         */
        async function loadFormFromUrl(url) {
            try {
                console.log(`[DEBUG] Step 1: Attempting to fetch from URL: ${url}`);
                mainContent.innerHTML = `<p class="text-center text-lg text-color">Loading assessment...</p>`;
                
                const response = await fetch(url);
                console.log(`[DEBUG] Step 2: Fetch response received. Status: ${response.status}, OK: ${response.ok}`);

                if (!response.ok) {
                    // This will handle 404 Not Found and other server errors.
                    throw new Error(`Form not found. Server responded with status: ${response.status}`);
                }
                
                console.log('[DEBUG] Step 3: Response is OK. Reading file data...');
                const data = await response.arrayBuffer();
                console.log(`[DEBUG] Step 4: File data received. Size: ${data.byteLength} bytes.`);
                
                // If the data is empty, it's a problem.
                if (data.byteLength === 0) {
                    throw new Error("The fetched file is empty.");
                }

                console.log('[DEBUG] Step 5: Processing spreadsheet...');
                processSpreadsheet(data);
                console.log('[DEBUG] Step 6: Spreadsheet processing complete.');

            } catch (error) {
                // This block will catch any error thrown in the try block.
                console.error("[DEBUG] An error occurred in the loading process:", error);
                mainContent.innerHTML = `<p class="text-center text-red-600 text-lg font-semibold">Error: Could not load the assessment.</p><p class="text-center text-red-500 mt-2">Please check the browser console for details (Press F12 and click 'Console').</p>`;
            }
        }

        
        /**
         * Handles the manual file upload from the input element.
         */
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => processSpreadsheet(e.target.result);
            reader.readAsArrayBuffer(file);
        }

        /**
         * Central function to parse spreadsheet data and start the form.
         * This is called by both the URL loader and the file uploader.
         * @param {ArrayBuffer} data - The raw spreadsheet data.
         */
        function processSpreadsheet(data) {
            try {
                const workbook = XLSX.read(data, { type: 'array' });
                formRules.environment = XLSX.utils.sheet_to_json(workbook.Sheets['Environment']);
                formRules.pages = XLSX.utils.sheet_to_json(workbook.Sheets['Pages']);
                formRules.questions = XLSX.utils.sheet_to_json(workbook.Sheets['FormQuestions']);
                // ... (add other sheets as needed)
                
                mainContent.classList.remove('text-center'); // Reset alignment
                uploaderContainer.classList.add('hidden-element'); // Hide uploader after successful load
                
                resetState();
                populateEnvironment();
                buildPage(userState.currentPage);

            } catch (error) {
                console.error("Error processing spreadsheet:", error);
                mainContent.innerHTML = `<p class="text-center text-red-500 text-lg">Error: Could not read the spreadsheet. Please ensure it is correctly formatted.</p>`;
            }
        }

        function resetState() {
            userState = {
                currentPage: 1,
                answers: {},
                // ... other state properties
            };
            resultsContainer.classList.add('hidden-element');
            formContainer.classList.remove('hidden-element');
            navContainer.classList.remove('hidden-element');
        }

        function populateEnvironment() {
            const getVar = (key, fallback = '') => (formRules.environment.find(v => v.Key === key) || {}).Value || fallback;

            document.getElementById('assessmentTitle').innerText = getVar('Assessment Title', 'Assessment');
            document.getElementById('assessmentIntro').innerText = getVar('Intro');

            const primaryNavContainer = document.getElementById('primaryNav');
            primaryNavContainer.innerHTML = '';
            getVar('Primary Nav').split(';').forEach(link => {
                const [text, url] = link.split(',').map(s => s.trim());
                let navItem;
                if (text === 'Restart') {
                    navItem = document.createElement('button');
                    navItem.className = "hover:underline";
                    navItem.onclick = () => {
                        resetState();
                        buildPage(1);
                    };
                } else {
                    navItem = document.createElement('a');
                    navItem.href = url;
                    navItem.target = "_blank";
                    navItem.className = "hover:underline";
                }
                navItem.innerText = text;
                primaryNavContainer.appendChild(navItem);
            });
            
             const footer = document.getElementById('pageFooter');
            footer.innerHTML = '<div id="secondaryNav" class="grid grid-cols-1 sm:grid-cols-3 gap-8 text-center sm:text-left"></div>';
            const secondaryNav = document.getElementById('secondaryNav');
            for (let i = 1; i <= 3; i++) {
                const col = document.createElement('div');
                const links = getVar(`Footer Col ${i} Links`, '').split(';').filter(Boolean);
                const title = getVar(`Footer Col ${i} Title`);
                if(title){
                    col.innerHTML = `<h3 class="font-bold text-white mb-2">${title}</h3><ul class="space-y-2"></ul>`;
                    const ul = col.querySelector('ul');
                    links.forEach(link => {
                        const [text, url] = link.split(',').map(s => s.trim());
                        ul.innerHTML += `<li><a href="${url}" target="_blank" class="text-yellow-100 hover:text-white">${text}</a></li>`;
                    });
                    secondaryNav.appendChild(col);
                }
            }
        }

        function buildPage(pageNum) {
            formContainer.innerHTML = '';
            // updateBreadcrumb(); // Your breadcrumb logic here
            
            const questionsForPage = formRules.questions.filter(q => q.Page === pageNum);
            const groupNames = [...new Set(questionsForPage.map(q => q.QuestionGroup).filter(Boolean))];
            
            groupNames.forEach(groupName => {
                const groupWrapper = document.createElement('fieldset');
                groupWrapper.className = "question-group p-4 rounded-lg mb-8";
                groupWrapper.innerHTML = `<legend class="text-xl font-bold px-2 heading-color">${groupName}</legend>`;
                
                questionsForPage.filter(q => q.QuestionGroup === groupName).forEach(q => {
                    groupWrapper.appendChild(createQuestionElement(q));
                });
                formContainer.appendChild(groupWrapper);
            });

            questionsForPage.filter(q => !q.QuestionGroup).forEach(q => {
                formContainer.appendChild(createQuestionElement(q));
            });

            updateNavigation();
        }

        function createQuestionElement(q) {
            const wrapper = document.createElement('div');
            wrapper.id = `q-wrapper-${q.QuestionID}`;
            wrapper.className = "mb-6 p-4";
            
            wrapper.innerHTML = `<label class="block text-lg font-semibold text-color mb-3">${q.QuestionText}</label>`;
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'space-y-2';

            if (q.QuestionType === 'multiple-choice' && q.AnswerOptions && String(q.AnswerOptions).trim()) {
                 String(q.AnswerOptions).split(',').forEach(opt => {
                    const cleanOpt = opt.trim();
                    const optionLabel = document.createElement('label');
                    optionLabel.className = 'flex items-center p-3 rounded-lg hover:bg-yellow-200 cursor-pointer';
                    optionLabel.innerHTML = `<input type="radio" name="question-${q.QuestionID}" value="${cleanOpt}" class="h-5 w-5 text-green-800 focus:ring-green-700 border-gray-500"><span class="ml-3 text-color">${cleanOpt}</span>`;
                    optionLabel.querySelector('input').onchange = () => console.log(`Answered ${q.QuestionID} with ${cleanOpt}`); // Placeholder
                    optionsContainer.appendChild(optionLabel);
                });
            }
            
            wrapper.appendChild(optionsContainer);
            return wrapper;
        }

        function updateNavigation(){
            // Simplified for this example. Add your page logic here.
            navContainer.innerHTML = `<button class="button-primary px-8 py-3 rounded-lg font-bold">Submit</button>`;
        }
        
    </script>
</body>
</html>
