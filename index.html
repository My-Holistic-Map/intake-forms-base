<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Dynamic Form Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden-question { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="max-w-5xl mx-auto p-4 sm:p-8">
        <!-- == Header Section (Dynamically Populated) == -->
        <header id="pageHeader" class="text-center mb-6">
            <h1 id="assessmentTitle" class="text-4xl font-bold text-gray-900">Dynamic Assessment</h1>
            <p id="assessmentIntro" class="text-lg text-gray-600 mt-2 max-w-3xl mx-auto"></p>
            <nav id="primaryNav" class="mt-4 flex justify-center items-center space-x-4 sm:space-x-6 text-gray-700"></nav>
        </header>
        
        <!-- == Breadcrumb Section (Dynamically Populated) == -->
        <div id="breadcrumbContainer" class="mb-4 text-sm text-gray-500"></div>

        <main id="formContainer" class="bg-white p-6 sm:p-8 rounded-xl shadow-md">
            <div class="text-center">
                <p class="text-lg font-semibold">Please upload the form rules spreadsheet to begin.</p>
                <input type="file" id="fileUploader" class="mt-4 mx-auto block w-full max-w-xs text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            </div>
        </main>

        <div id="navigationContainer" class="mt-8 text-center"></div>
        <div id="resultsContainer" class="hidden mt-8"></div>

        <!-- == Footer Section (Dynamically Populated) == -->
        <footer id="pageFooter" class="mt-12 pt-8 border-t border-gray-200"></footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let formRules = {
            questions: [],
            remediation: [],
            content: [],
            environment: [],
            pages: []
        };
        let userState = {
            currentPage: 1,
            answers: {},
            categoryScores: {},
            primaryNeurotransmitter: null,
            remediationData: { primarySupplement: '', secondarySupplement: '', note: '' }
        };

        const fileUploader = document.getElementById('fileUploader');
        fileUploader.addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Read all sheets into the rules object
                    formRules.environment = XLSX.utils.sheet_to_json(workbook.Sheets['Environment']);
                    formRules.pages = XLSX.utils.sheet_to_json(workbook.Sheets['Pages']);
                    formRules.questions = XLSX.utils.sheet_to_json(workbook.Sheets['FormQuestions']);
                    formRules.remediation = XLSX.utils.sheet_to_json(workbook.Sheets['RemediationRules']);
                    formRules.content = XLSX.utils.sheet_to_json(workbook.Sheets['ResultContent']);
                    
                    resetState();
                    populateEnvironment();
                    buildPage(userState.currentPage);
                } catch (error) {
                    console.error("Error processing spreadsheet:", error);
                    document.getElementById('formContainer').innerHTML = `<p class="text-red-600 text-center">Error: Could not read the spreadsheet. Please ensure it has the sheets: Environment, Pages, FormQuestions, RemediationRules, and ResultContent.</p>`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function resetState() {
            userState = {
                currentPage: 1,
                answers: {},
                categoryScores: {},
                primaryNeurotransmitter: null,
                remediationData: { primarySupplement: 'Default: Essential Nutrients', secondarySupplement: 'Default: Magnesium + Zinc', note: null }
            };
            document.getElementById('resultsContainer').classList.add('hidden');
            document.getElementById('formContainer').classList.remove('hidden');
            document.getElementById('navigationContainer').classList.remove('hidden');
        }

        function populateEnvironment() {
            const getVar = (key) => (formRules.environment.find(v => v.Key === key) || {}).Value || '';

            document.getElementById('assessmentTitle').innerText = getVar('Assessment Title');
            document.getElementById('assessmentIntro').innerText = getVar('Intro');

            const primaryNavContainer = document.getElementById('primaryNav');
            primaryNavContainer.innerHTML = '';
            getVar('Primary Nav').split(';').forEach(link => {
                const [text, url] = link.split(',').map(s => s.trim());
                if (text === 'Restart') {
                    const button = document.createElement('button');
                    button.innerText = text;
                    button.className = "hover:text-blue-600 hover:underline";
                    button.onclick = () => {
                        resetState();
                        buildPage(1);
                    };
                    primaryNavContainer.appendChild(button);
                } else {
                    const a = document.createElement('a');
                    a.innerText = text;
                    a.href = url;
                    a.target = "_blank";
                    a.className = "hover:text-blue-600 hover:underline";
                    primaryNavContainer.appendChild(a);
                }
            });

            const footer = document.getElementById('pageFooter');
            footer.innerHTML = '<div id="secondaryNav" class="grid grid-cols-1 sm:grid-cols-3 gap-8 text-center sm:text-left"></div>';
            const secondaryNav = document.getElementById('secondaryNav');
            for (let i = 1; i <= 3; i++) {
                const col = document.createElement('div');
                const links = getVar(`Footer Col ${i} Links`).split(';').filter(Boolean);
                const title = getVar(`Footer Col ${i} Title`);
                col.innerHTML = `<h3 class="font-bold text-gray-900 mb-2">${title}</h3><ul class="space-y-2"></ul>`;
                const ul = col.querySelector('ul');
                links.forEach(link => {
                    const [text, url] = link.split(',').map(s => s.trim());
                    ul.innerHTML += `<li><a href="${url}" target="_blank" class="text-gray-600 hover:text-blue-600">${text}</a></li>`;
                });
                secondaryNav.appendChild(col);
            }
        }
        
        function updateBreadcrumb() {
            const container = document.getElementById('breadcrumbContainer');
            const totalPages = Math.max(...formRules.pages.map(p => p.PageNumber));
            const assessmentTitle = (formRules.environment.find(v => v.Key === 'Assessment Title') || {}).Value || 'Assessment';
            const currentPageInfo = formRules.pages.find(p => p.PageNumber === userState.currentPage);
            const pageTitle = currentPageInfo ? currentPageInfo.PageTitle : `Page ${userState.currentPage}`;
            const percentComplete = Math.round((userState.currentPage -1) / totalPages * 100);
            
            container.innerHTML = `${assessmentTitle} &rarr; ${pageTitle} &rarr; <strong class="text-blue-600">${userState.currentPage} of ${totalPages} (${percentComplete}%)</strong>`;
        }


        function buildPage(pageNum) {
            document.getElementById('formContainer').innerHTML = '';
            updateBreadcrumb();
            
            const questionsForPage = formRules.questions.filter(q => q.Page === pageNum);
            const groupNames = [...new Set(questionsForPage.map(q => q.QuestionGroup).filter(Boolean))];
            
            groupNames.forEach(groupName => {
                const groupWrapper = document.createElement('fieldset');
                groupWrapper.className = "border-2 border-gray-200 p-4 rounded-lg mb-8";
                groupWrapper.innerHTML = `<legend class="text-xl font-bold text-gray-800 px-2">${groupName}</legend>`;
                
                questionsForPage.filter(q => q.QuestionGroup === groupName).forEach(q => {
                    groupWrapper.appendChild(createQuestionElement(q));
                });
                document.getElementById('formContainer').appendChild(groupWrapper);
            });

            questionsForPage.filter(q => !q.QuestionGroup).forEach(q => {
                document.getElementById('formContainer').appendChild(createQuestionElement(q));
            });

            updateNavigation();
        }

        function createQuestionElement(q) {
            const wrapper = document.createElement('div');
            wrapper.id = `q-wrapper-${q.QuestionID}`;
            wrapper.className = "mb-6 p-4";
            if (q.ShowHideLogic && !evaluateShowHideLogic(q.ShowHideLogic)) {
                wrapper.classList.add('hidden-question');
            }
            wrapper.innerHTML = `<label class="block text-lg font-semibold text-gray-800 mb-3">${q.QuestionText}</label>`;
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'space-y-2';

            if (q.QuestionType === 'multiple-choice' && q.AnswerOptions && String(q.AnswerOptions).trim()) {
                String(q.AnswerOptions).split(',').forEach(opt => {
                    const cleanOpt = opt.trim();
                    const optionLabel = document.createElement('label');
                    optionLabel.className = 'flex items-center p-3 rounded-lg hover:bg-gray-100 cursor-pointer';
                    optionLabel.innerHTML = `
                        <input type="radio" name="question-${q.QuestionID}" value="${cleanOpt}" class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300">
                        <span class="ml-3">${cleanOpt}</span>`;
                    optionLabel.querySelector('input').onchange = () => handleAnswerChange(q.QuestionID, cleanOpt);
                    optionsContainer.appendChild(optionLabel);
                });
            } else if(q.QuestionType === 'multiple-choice') {
                 optionsContainer.innerHTML = `<p class="text-red-500 text-sm">Config Error: Missing AnswerOptions for QID ${q.QuestionID}.</p>`;
            }
            
            wrapper.appendChild(optionsContainer);
            return wrapper;
        }

        function updateNavigation() {
            const navContainer = document.getElementById('navigationContainer');
            navContainer.innerHTML = '';
            const maxPage = Math.max(...formRules.pages.map(p => p.PageNumber));

            if (userState.currentPage < maxPage) {
                const nextBtn = document.createElement('button');
                nextBtn.innerText = 'Next';
                nextBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105';
                nextBtn.onclick = () => {
                    if (userState.currentPage === 1) calculateInitialScores();
                    userState.currentPage++;
                    buildPage(userState.currentPage);
                };
                navContainer.appendChild(nextBtn);
            } else {
                const submitBtn = document.createElement('button');
                submitBtn.innerText = 'Get My Plan';
                submitBtn.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105';
                submitBtn.onclick = displayResults;
                navContainer.appendChild(submitBtn);
            }
        }
        
        function handleAnswerChange(questionId, value) {
            userState.answers[questionId] = value;
            formRules.questions.forEach(q => {
                if (q.ShowHideLogic) {
                    const wrapper = document.getElementById(`q-wrapper-${q.QuestionID}`);
                    if (wrapper) {
                         wrapper.classList.toggle('hidden-question', !evaluateShowHideLogic(q.ShowHideLogic));
                    }
                }
            });
        }

        function evaluateShowHideLogic(logicString) {
            if (!logicString) return true;
            if (logicString.startsWith('PRIMARY_NT:')) {
                return userState.primaryNeurotransmitter === logicString.split(':')[1];
            }
            const [questionId, requiredAnswer] = logicString.split(':');
            return userState.answers[questionId] === requiredAnswer;
        }

        function calculateInitialScores() {
            const scores = {};
            formRules.questions.filter(q => q.Page === 1).forEach(q => {
                const answer = userState.answers[q.QuestionID];
                const opts = q.AnswerOptions ? String(q.AnswerOptions).split(',') : [];
                const vals = q.AnswerValues ? String(q.AnswerValues).split(',') : [];
                const answerIndex = opts.map(o => o.trim()).indexOf(answer);

                if (answerIndex > -1 && q.Category && vals.length > answerIndex) {
                    scores[q.Category] = (scores[q.Category] || 0) + (parseInt(vals[answerIndex].trim()) || 0);
                }
            });
            userState.categoryScores = scores;
            if (Object.keys(scores).length > 0) {
                userState.primaryNeurotransmitter = Object.entries(scores).reduce((a, b) => a[1] >= b[1] ? a : b)[0];
            }
        }
        
        function displayResults() {
            formRules.questions.filter(q => q.Page === userState.currentPage).forEach(q => {
                const answer = userState.answers[q.QuestionID];
                if (q.LinkedOutcome && answer && q.AnswerOptions) {
                    const outcomes = String(q.LinkedOutcome).split(',');
                    const opts = String(q.AnswerOptions).split(',');
                    const answerIndex = opts.map(o => o.trim()).indexOf(answer);

                    if (answerIndex > -1 && outcomes.length > answerIndex && outcomes[answerIndex]) {
                        const outcomeStr = outcomes[answerIndex].trim();
                        if(outcomeStr) {
                            const [key, ...valParts] = outcomeStr.split(':');
                            const value = valParts.join(':').trim();
                            if (key === 'SET_PRIMARY_SUPPLEMENT') userState.remediationData.primarySupplement = value;
                            if (key === 'SET_SECONDARY_SUPPLEMENT') userState.remediationData.secondarySupplement = value;
                            if (key === 'SET_NOTE') userState.remediationData.note = value;
                        }
                    }
                }
            });
            document.getElementById('formContainer').classList.add('hidden');
            document.getElementById('navigationContainer').classList.add('hidden');
            document.getElementById('breadcrumbContainer').innerHTML = '<strong>Results</strong>';
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = buildResultsHTML();
            resultsContainer.classList.remove('hidden');
            document.getElementById('resetButton-results').onclick = () => {
                resetState();
                buildPage(1);
            };
        }

        function buildResultsHTML() {
            const primaryNT = userState.primaryNeurotransmitter;
            if (!primaryNT) return '<p>Could not determine a primary focus. Please try the assessment again.</p>';
            const lifestyle = formRules.content.filter(c => c.ContentType === 'lifestyle' && c.Category === primaryNT);
            const foundations = formRules.content.filter(c => c.ContentType === 'foundation');
            const multipleRule = formRules.remediation.find(r => r.RuleID === 'MultipleImbalances');
            const hasMultiple = Object.values(userState.categoryScores).filter(s => s > 0).length > 1;

            return `
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                    <div class="text-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Your Personalized Brain Health Plan</h2>
                        <button id="resetButton-results" class="mt-2 text-blue-600 hover:underline">Start New Assessment</button>
                    </div>
                    ${hasMultiple && multipleRule ? `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 mb-6 rounded-r-lg"><p><strong>Multiple Neurotransmitter Imbalances Detected:</strong> ${multipleRule.ResultMessage}</p></div>` : ''}
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold mb-4">Primary Focus: <span class="text-blue-700">${primaryNT}</span></h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg"><h4 class="font-bold text-green-800">Primary Supplement</h4><p class="text-green-700">${userState.remediationData.primarySupplement}</p></div>
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg"><h4 class="font-bold text-blue-800">Secondary Supplement</h4><p class="text-blue-700">${userState.remediationData.secondarySupplement}</p></div>
                        </div>
                        ${userState.remediationData.note ? `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 mt-4 rounded-r-lg"><p><strong>Important Note:</strong> ${userState.remediationData.note}</p></div>` : ''}
                    </div>
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold mb-4">Key Lifestyle Actions for ${primaryNT}</h3>
                        <ul class="list-disc list-inside space-y-2">${lifestyle.map(a => `<li class="text-gray-700">${a.Content}</li>`).join('')}</ul>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold mb-4">Brain Health Foundations</h3>
                        <div class="space-y-4">${foundations.map(f => {
                            const c = f.Content || '', parts = c.split('**Actions:**'), desc = parts[0].replace('**Description:**', '').trim(), acts = parts.length > 1 ? parts[1].split(';').map(a => a.trim()).join(', ') : '';
                            return `<div class="p-4 border rounded-lg"><h4 class="font-bold">${f.Category}</h4><p class="text-sm text-gray-600">${desc}</p><p class="text-sm text-blue-700 mt-1"><strong>Actions:</strong> ${acts}</p></div>`;
                        }).join('')}</div>
                    </div>
                </div>`;
        }
    </script>
</body>
</html>
