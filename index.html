<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Assessment Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #879683 0%, #404e2c 100%);
        }
        .hidden-element { display: none !important; }
        .form-container { background-color: #fed695; border: 2px solid #879683; }
        .header-gradient { background: linear-gradient(135deg, #3b3e2e 0%, #404e2c 100%); }
        .heading-color { color: #a15236; }
        .text-color { color: #3b3e2e; }
        .button-primary { background: linear-gradient(135deg, #a15236 0%, #483621 100%); color: #fed695; transition: opacity 0.2s; }
        .button-primary:hover { opacity: 0.9; }
        .button-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .button-secondary { background-color: #879683; color: #fed695; transition: background-color 0.2s; }
        .button-secondary:hover { background-color: #767034; }
        .question-group { border: 2px solid #879683; }
        .question-group legend { color: #a15236; }
        .result-card { background: linear-gradient(135deg, #767034 0%, #483621 100%); color: #fed695; }
        .result-card-top { border: 2px solid #a15236; }
    </style>
</head>
<body class="text-gray-800">

    <div class="max-w-4xl mx-auto p-4 sm:p-6">
        <header id="pageHeader" class="text-center mb-6 rounded-lg shadow-lg p-6 header-gradient text-white">
            <h1 id="assessmentTitle" class="text-4xl font-bold text-yellow-200">Assessment Engine</h1>
            <p id="assessmentIntro" class="text-lg text-yellow-100 mt-2 max-w-3xl mx-auto"></p>
            <nav id="primaryNav" class="mt-4 flex justify-center items-center flex-wrap gap-x-6 gap-y-2 text-yellow-200"></nav>
        </header>
        
        <div id="breadcrumbContainer" class="mb-4 text-sm text-white px-2"></div>

        <main id="mainContent">
            <div id="uploaderContainer" class="form-container p-6 sm:p-8 rounded-xl shadow-2xl text-center">
                <h2 class="text-2xl font-bold heading-color">Test an Assessment</h2>
                <p class="text-lg text-color mt-2">Upload a spreadsheet to begin.</p>
                <input type="file" id="fileUploader" class="mt-4 mx-auto block w-full max-w-xs text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            </div>
            <div id="formContainer" class="form-container p-6 sm:p-8 rounded-xl shadow-2xl hidden-element"></div>
        </main>

        <div id="navigationContainer" class="mt-8 flex justify-between items-center"></div>
        <div id="resultsContainer" class="hidden-element mt-8"></div>

        <footer id="pageFooter" class="mt-12 pt-8 border-t border-gray-400 border-opacity-50 text-white"></footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let formRules = {};
        let userState = {};
        let lastLoadedData = null;

        const mainContent = document.getElementById('mainContent');
        const uploaderContainer = document.getElementById('uploaderContainer');
        const formContainer = document.getElementById('formContainer');
        const navContainer = document.getElementById('navigationContainer');
        const resultsContainer = document.getElementById('resultsContainer');
        const fileUploader = document.getElementById('fileUploader');
        
        fileUploader.addEventListener('change', handleFileUpload);
        
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const formName = params.get('form');
            if (formName) {
                const filePath = `./forms/sheets/${formName}.xlsx`; 
                loadFormFromUrl(filePath);
            } else {
                uploaderContainer.classList.remove('hidden-element');
            }
        });

        async function loadFormFromUrl(url) {
            try {
                mainContent.innerHTML = `<p class="text-center text-lg text-white">Loading assessment...</p>`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Form not found. Server responded with status: ${response.status}`);
                const data = await response.arrayBuffer();
                lastLoadedData = data;
                processSpreadsheet(data);
            } catch (error) {
                console.error("Error loading form from URL:", error);
                mainContent.innerHTML = `<p class="text-center text-red-300 text-lg">Error: The requested assessment could not be loaded.</p>`;
            }
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                lastLoadedData = e.target.result;
                processSpreadsheet(e.target.result);
            };
            reader.readAsArrayBuffer(file);
        }

        function processSpreadsheet(data) {
            try {
                const workbook = XLSX.read(data, { type: 'array' });
                formRules = {
                    environment: XLSX.utils.sheet_to_json(workbook.Sheets['Environment']),
                    pages: XLSX.utils.sheet_to_json(workbook.Sheets['Pages']),
                    questions: XLSX.utils.sheet_to_json(workbook.Sheets['FormQuestions']),
                    remediation: XLSX.utils.sheet_to_json(workbook.Sheets['RemediationRules']),
                    content: XLSX.utils.sheet_to_json(workbook.Sheets['ResultContent'])
                };
                mainContent.innerHTML = '';
                mainContent.appendChild(uploaderContainer);
                mainContent.appendChild(formContainer);
                uploaderContainer.classList.add('hidden-element');
                formContainer.classList.remove('hidden-element');
                resetState();
                populateEnvironment();
                buildPage(userState.currentPage);
            } catch (error) {
                console.error("Error processing spreadsheet:", error);
                mainContent.innerHTML = `<p class="text-center text-red-300 text-lg">Error: Could not read the spreadsheet.</p>`;
            }
        }
        
        function resetState() {
            userState = {
                currentPage: 1,
                answers: {},
                categoryScores: {},
                stateVariables: {}
            };
            resultsContainer.classList.add('hidden-element');
            formContainer.classList.remove('hidden-element');
            navContainer.classList.remove('hidden-element');
        }

        function populateEnvironment() {
            const getVar = (key, fallback = '') => (formRules.environment.find(v => v.Key === key) || {}).Value || fallback;
            document.getElementById('assessmentTitle').innerText = getVar('Assessment Title', 'Assessment');
            document.getElementById('assessmentIntro').innerText = getVar('Intro');
            const primaryNavContainer = document.getElementById('primaryNav');
            primaryNavContainer.innerHTML = '';
            getVar('Primary Nav', '').split(';').forEach(link => {
                const [text, url] = link.split(',').map(s => s.trim());
                let navItem;
                if (text === 'Restart') {
                    navItem = document.createElement('button');
                    navItem.className = "hover:underline";
                    navItem.onclick = () => { if (lastLoadedData) processSpreadsheet(lastLoadedData); };
                } else {
                    navItem = document.createElement('a');
                    navItem.href = url;
                    navItem.target = "_blank";
                    navItem.className = "hover:underline";
                }
                navItem.innerText = text;
                primaryNavContainer.appendChild(navItem);
            });
            const footer = document.getElementById('pageFooter');
            footer.innerHTML = '<div id="secondaryNav" class="grid grid-cols-1 sm:grid-cols-3 gap-8 text-center sm:text-left"></div>';
            const secondaryNav = document.getElementById('secondaryNav');
            for (let i = 1; i <= 3; i++) {
                const col = document.createElement('div');
                const links = getVar(`Footer Col ${i} Links`, '').split(';').filter(Boolean);
                const title = getVar(`Footer Col ${i} Title`);
                if(title){
                    col.innerHTML = `<h3 class="font-bold text-white mb-2">${title}</h3><ul class="space-y-2"></ul>`;
                    const ul = col.querySelector('ul');
                    links.forEach(link => {
                        const [text, url] = link.split(',').map(s => s.trim());
                        ul.innerHTML += `<li><a href="${url}" target="_blank" class="text-yellow-100 hover:text-white">${text}</a></li>`;
                    });
                    secondaryNav.appendChild(col);
                }
            }
        }

        function buildPage(pageNum) {
            formContainer.innerHTML = '';
            const questionsForPage = formRules.questions.filter(q => q.Page === pageNum);
            const groupNames = [...new Set(questionsForPage.map(q => q.QuestionGroup).filter(Boolean))];
            groupNames.forEach(groupName => {
                const groupWrapper = document.createElement('fieldset');
                groupWrapper.className = "question-group p-4 rounded-lg mb-8";
                groupWrapper.innerHTML = `<legend class="text-xl font-bold px-2">${groupName}</legend>`;
                questionsForPage.filter(q => q.QuestionGroup === groupName).forEach(q => groupWrapper.appendChild(createQuestionElement(q)));
                formContainer.appendChild(groupWrapper);
            });
            questionsForPage.filter(q => !q.QuestionGroup).forEach(q => formContainer.appendChild(createQuestionElement(q)));
            updateNavigation();
        }

        function createQuestionElement(q) {
            const wrapper = document.createElement('div');
            wrapper.id = `q-wrapper-${q.QuestionID}`;
            wrapper.className = "mb-6 p-4";
            wrapper.innerHTML = `<label class="block text-lg font-semibold text-color mb-3">${q.QuestionText}</label>`;
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'space-y-2';
            const options = q.AnswerOptions ? String(q.AnswerOptions).split(',') : [];

            if (q.QuestionType === 'multiple-choice' && options.length > 0) {
                 options.forEach(opt => {
                    const cleanOpt = opt.trim();
                    const optionLabel = document.createElement('label');
                    optionLabel.className = 'flex items-center p-3 rounded-lg hover:bg-yellow-200 cursor-pointer';
                    optionLabel.innerHTML = `<input type="radio" name="question-${q.QuestionID}" value="${cleanOpt}" class="h-5 w-5 text-green-800 focus:ring-green-700 border-gray-500"><span class="ml-3 text-color">${cleanOpt}</span>`;
                    optionLabel.querySelector('input').onchange = () => handleAnswerChange(q.QuestionID, cleanOpt);
                    optionsContainer.appendChild(optionLabel);
                });
            } else if (q.QuestionType === 'multiple-selection' && options.length > 0) {
                options.forEach(opt => {
                    const cleanOpt = opt.trim();
                    const optionLabel = document.createElement('label');
                    optionLabel.className = 'flex items-center p-3 rounded-lg hover:bg-yellow-200 cursor-pointer';
                    optionLabel.innerHTML = `<input type="checkbox" name="question-${q.QuestionID}" value="${cleanOpt}" class="h-5 w-5 text-green-800 focus:ring-green-700 border-gray-500 rounded"><span class="ml-3 text-color">${cleanOpt}</span>`;
                    optionLabel.querySelector('input').onchange = (e) => handleAnswerChange(q.QuestionID, cleanOpt, e.target.checked);
                    optionsContainer.appendChild(optionLabel);
                });
            } else if (q.QuestionType === 'dropdown' && options.length > 0) {
                const select = document.createElement('select');
                select.name = `question-${q.QuestionID}`;
                select.className = 'w-full max-w-md py-2 px-3 border-2 rounded-lg text-color text-base';
                select.style.borderColor = '#879683';
                select.style.backgroundColor = '#fed695';
                select.innerHTML = `<option value="" disabled selected>Select an option...</option>`;
                options.forEach(opt => {
                    const cleanOpt = opt.trim();
                    select.innerHTML += `<option value="${cleanOpt}">${cleanOpt}</option>`;
                });
                select.onchange = () => handleAnswerChange(q.QuestionID, select.value);
                optionsContainer.appendChild(select);
            } else {
                optionsContainer.innerHTML = `<p class="text-red-500 text-sm">Config Error: Question ID ${q.QuestionID} is missing AnswerOptions.</p>`;
            }
            wrapper.appendChild(optionsContainer);
            return wrapper;
        }

        function handleAnswerChange(questionId, value, isChecked) {
            const question = formRules.questions.find(q => q.QuestionID === questionId);
            if (!question) return;

            if (question.QuestionType === 'multiple-selection') {
                if (!userState.answers[questionId]) userState.answers[questionId] = [];
                const currentAnswers = userState.answers[questionId];
                if (isChecked) {
                    currentAnswers.push(value);
                } else {
                    userState.answers[questionId] = currentAnswers.filter(ans => ans !== value);
                }
            } else {
                userState.answers[questionId] = value;
            }
            updateNavigation();
        }

        function checkPageValidity() {
            const questionsOnPage = formRules.questions.filter(q => q.Page === userState.currentPage);
            for (const q of questionsOnPage) {
                if (q.IsRequired) {
                    const answer = userState.answers[q.QuestionID];
                    if (!answer || (Array.isArray(answer) && answer.length === 0)) {
                        return false; 
                    }
                }
            }
            return true;
        }

        function updateNavigation() {
            navContainer.innerHTML = '';
            const maxPage = Math.max(...formRules.pages.map(p => p.PageNumber));
            const isPageValid = checkPageValidity();

            if (userState.currentPage > 1) {
                const backBtn = document.createElement('button');
                backBtn.innerText = 'Back';
                backBtn.className = 'button-secondary px-8 py-3 rounded-lg font-bold';
                backBtn.onclick = () => {
                    userState.currentPage--;
                    buildPage(userState.currentPage);
                };
                navContainer.appendChild(backBtn);
            } else {
                 navContainer.appendChild(document.createElement('div'));
            }

            if (userState.currentPage < maxPage) {
                const nextBtn = document.createElement('button');
                nextBtn.innerText = 'Next';
                nextBtn.className = 'button-primary px-8 py-3 rounded-lg font-bold';
                nextBtn.disabled = !isPageValid;
                nextBtn.onclick = () => {
                    userState.currentPage++;
                    buildPage(userState.currentPage);
                };
                navContainer.appendChild(nextBtn);
            } else {
                const submitBtn = document.createElement('button');
                submitBtn.innerText = 'Get Results';
                submitBtn.className = 'button-primary px-8 py-3 rounded-lg font-bold';
                submitBtn.disabled = !isPageValid;
                submitBtn.onclick = displayResults;
                navContainer.appendChild(submitBtn);
            }
        }
        
        function displayResults() {
            formContainer.classList.add('hidden-element');
            navContainer.classList.add('hidden-element');
            calculateFinalState();
            resultsContainer.innerHTML = buildResultsHTML();
            resultsContainer.classList.remove('hidden-element');
            
            const newResetButton = resultsContainer.querySelector('.restart-button');
            if(newResetButton) {
                newResetButton.onclick = () => { if (lastLoadedData) processSpreadsheet(lastLoadedData); };
            }
        }

        function calculateFinalState() {
            userState.categoryScores = {};
            userState.stateVariables = {};

            formRules.questions.forEach(q => {
                const answer = userState.answers[q.QuestionID];
                if (!answer || !q.LinkedOutcome) return;

                const options = String(q.AnswerOptions).split(',');
                const outcomes = String(q.LinkedOutcome).split(',');

                const processOutcome = (outcomeStr) => {
                    if (!outcomeStr) return;
                    outcomeStr.split(';').forEach(singleOutcome => {
                        const [action, ...params] = singleOutcome.trim().split(':');
                        const value = params.join(':');
                        
                        if (action === 'SET_STATE_VARIABLE') {
                            const [varName, ...varValueParts] = value.split(':');
                            userState.stateVariables[varName.trim()] = varValueParts.join(':').trim();
                        } else if (action === 'ADD_SCORE_TO_CATEGORY' || action === 'INCREMENT_CATEGORY_SCORE') {
                            const [category, score] = value.split(':');
                            userState.categoryScores[category.trim()] = (userState.categoryScores[category.trim()] || 0) + parseInt(score);
                        }
                    });
                };

                if (Array.isArray(answer)) {
                    answer.forEach(ans => {
                        const answerIndex = options.map(o => o.trim()).indexOf(ans);
                        if(answerIndex > -1) processOutcome(outcomes[answerIndex]);
                    });
                } else {
                    const answerIndex = options.map(o => o.trim()).indexOf(answer);
                    if(answerIndex > -1) processOutcome(outcomes[answerIndex]);
                }
            });
        }
        
        function evaluateCondition(conditionStr) {
            if (!conditionStr || conditionStr.trim().toUpperCase() === 'ALWAYS_TRUE') return true;
            const conditions = conditionStr.split(';').map(s => s.trim());
            return conditions.some(cond => {
                try {
                    const [type, logic] = cond.split(':');
                    if (type.toUpperCase() === 'SCORE') {
                        const match = logic.match(/(.+?) (>=|<=|>|<|=) (.+)/);
                        if (!match) return false;
                        const [, category, operator, value] = match.map(s => s.trim());
                        const score = userState.categoryScores[category] || 0;
                        return eval(`${score} ${operator} ${value}`);
                    }
                    if (type.toUpperCase() === 'STATE') {
                        const [varName, varValue] = logic.split('=').map(s => s.trim());
                        return userState.stateVariables[varName] === varValue;
                    }
                } catch(e) { return false; }
                return false;
            });
        }
        
        function buildResultsHTML() {
            let html = `<div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold heading-color mb-6">Your Recommendations</h2>`;
            
            const resultCards = [];
            const supportCards = [];
            const notes = [];
            let templateResult = '';

            formRules.remediation.forEach(rule => {
                if (evaluateCondition(rule.Condition)) {
                    if (rule.Action) {
                        const actionType = rule.Action.split(':')[0];
                        const category = rule.Action.split(':')[1];
                        const content = formRules.content.find(c => c.Category === category);
                        if (!content) return;
                        
                        if(actionType === 'SHOW_RESULT_CARD') resultCards.push(content);
                        if(actionType === 'SHOW_SUPPORT_CARD') supportCards.push(content);
                        if(actionType === 'SHOW_NOTE') notes.push(content);
                    } else if (rule.ResultMessage) {
                         templateResult += processTemplate(rule.ResultMessage);
                    }
                }
            });

            if (templateResult) {
                html += `<div class="result-card p-4 rounded-lg">${templateResult}</div>`;
            }

            resultCards.sort((a,b) => (userState.categoryScores[b.Category] || 0) - (userState.categoryScores[a.Category] || 0));
            if (resultCards.length > 0) {
                 html += `<div class="space-y-4 mb-6">`;
                 resultCards.forEach((card, index) => {
                     html += `<div class="result-card p-4 rounded-lg ${index === 0 ? 'result-card-top' : ''}">${card.Content.replace(/\*\*(.*?)\*\*/g, '<br><strong>$1</strong>')}</div>`;
                 });
                 html += `</div>`;
            }

            if (supportCards.length > 0) {
                 html += `<h3 class="text-xl font-semibold heading-color mt-6 mb-4">Additional Support</h3>
                          <div class="space-y-4 mb-6">`;
                 supportCards.forEach(card => {
                     html += `<div class="bg-gray-200 p-4 rounded-lg text-color">${card.Content.replace(/\*\*(.*?)\*\*/g, '<br><strong>$1</strong>')}</div>`;
                 });
                 html += `</div>`;
            }

             if (notes.length > 0) {
                 html += `<div class="space-y-4">`;
                 notes.forEach(note => {
                     html += `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-r-lg">${note.Content}</div>`;
                 });
                 html += `</div>`;
            }

            html += `<div class="text-center mt-8"><button class="restart-button button-primary px-8 py-3 rounded-lg font-bold">Start Over</button></div>`;
            html += `</div>`;
            return html;
        }

        // --- FIX: Rewrote template processing to be safer and more robust ---
        function processTemplate(templateStr) {
            let processedText = templateStr;
            const placeholders = templateStr.match(/\{(.+?)\}/g) || [];

            placeholders.forEach(placeholder => {
                const key = placeholder.replace(/[{}]/g, '');
                let replacement = '';
                
                try {
                    if (key === 'PregnancyWarning') {
                        if (userState.stateVariables.isPregnant === 'true') {
                            replacement = (formRules.content.find(c => c.Category === 'PregnancyWarning') || {}).Content || '';
                        }
                    } else if (key === 'RecommendationText') {
                        const healthConcern = userState.answers[10];
                        const recData = formRules.content.find(c => c.ContentType === 'HealthConcernRec' && c.Category === healthConcern);
                        
                        if (recData && recData.Content) {
                            const primaryMatch = recData.Content.match(/\*\*Primary:\*\* (.*?)(?=\s\*\*|$)/);
                            const optionsMatch = recData.Content.match(/\*\*Options:\*\* (.*)/);

                            const primary = primaryMatch ? primaryMatch[1].trim() : '';
                            const options = optionsMatch ? optionsMatch[1].split(',').map(s => s.trim()) : ['', ''];
                            
                            if (userState.stateVariables.triedBoth === 'true') {
                                replacement = `Since both strong antimicrobials didn't work, try <strong>${primary}</strong>. If it doesn't work, try <strong>${options[0]}</strong> or <strong>${options[1]}</strong>.`;
                            } else if (userState.stateVariables.recommendedAntimicrobial) {
                                replacement = `Try <strong>${userState.stateVariables.recommendedAntimicrobial}</strong> with <strong>${primary}</strong>. If it doesn't work, try <strong>${options[0]}</strong> or <strong>${options[1]}</strong>.`;
                            } else {
                                replacement = `Try <strong>${primary}</strong>. If it doesn't work, try <strong>${options[0]}</strong> or <strong>${options[1]}</strong>.`;
                            }
                        }
                    } else if (key === 'AdditionalAdviceText') {
                        const adviceParts = [];
                        if (userState.stateVariables.hasHPyloriSymptoms === 'true') {
                           const advice = (formRules.content.find(c => c.Category === 'HPyloriAdvice') || {}).Content || '';
                           if(advice) adviceParts.push(advice);
                        }
                        if (userState.answers[3] === 'Yes' || userState.answers[8] === 'Yes') { // SIBO symptoms
                           const advice = (formRules.content.find(c => c.Category === 'SIBOAdvice') || {}).Content || '';
                           if(advice) adviceParts.push(advice);
                        }
                        if (userState.stateVariables.additionalAdvice) {
                           const cleanAdvice = userState.stateVariables.additionalAdvice.replace(/^Also,?\s*/i, '');
                           adviceParts.push(cleanAdvice);
                        }
                        replacement = adviceParts.length > 0 ? `<em>${adviceParts.join(' ')}</em>` : '';
                    }
                } catch (e) {
                    console.error(`Error processing placeholder: ${placeholder}`, e);
                    replacement = `[Error: ${key}]`;
                }
                
                processedText = processedText.replace(placeholder, replacement);
            });

            return processedText;
        }

    </script>
</body>
</html>
